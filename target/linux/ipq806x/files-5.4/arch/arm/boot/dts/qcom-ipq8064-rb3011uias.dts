#include "qcom-ipq8064-v2.0.dtsi"

#include <dt-bindings/input/input.h>

/ {
	model = "MikroTik RouterBOARD RB3011UiAS";
	compatible = "mikrotik,rb3011uias", "qcom,ipq8064";

	memory@0 {
		reg = <0x42000000 0x3e000000>;
		device_type = "memory";
	};

	reserved-memory {
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;

		rsvd@41200000 {
			reg = <0x41200000 0x300000>;
			no-map;
		};

		rsvd@7f000000 { /* 16 Mb for ramoops */
			reg = <0x7f000000 0x1000000>;
			reusable;
		};
	};

	aliases {
		led-upgrade = &general;
		mdio-gpio0 = &mdio0;
		mdio-gpio1 = &mdio1;
		serial0 = &gsbi7_serial;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};

	i2c_sfp: i2c {
		compatible = "i2c-gpio";
		sda-gpios = <&qcom_pinmux 8 (GPIO_ACTIVE_HIGH|GPIO_OPEN_DRAIN)>;
		scl-gpios = <&qcom_pinmux 9 (GPIO_ACTIVE_HIGH|GPIO_OPEN_DRAIN)>;
		i2c-gpio,delay-us = <5>;
		i2c-gpio,timeout-ms = <1>;
	};

	keys {
		compatible = "gpio-keys";

		reset {
			gpios = <&qcom_pinmux 66 GPIO_ACTIVE_LOW>;
			label = "reset";
			linux,code = <KEY_RESTART>;
			pinctrl-0 = <&reset_button_pins>;
			pinctrl-names = "default";
		};
	};

	leds {
		compatible = "gpio-leds";

		general: general {
			gpios = <&qcom_pinmux 33 GPIO_ACTIVE_HIGH>;
			label = "rb3011uias:green:general";
			pinctrl-0 = <&led_general_pins>;
			pinctrl-names = "default";
		};
	};

	sfp_gmac1: sfp {
		compatible = "sff,sfp";
		i2c-bus = <&i2c_sfp>;
		los-gpios = <&qcom_pinmux 68 GPIO_ACTIVE_HIGH>;
		maximum-power-milliwatt = <2000>;
		mod-def0-gpios = <&qcom_pinmux 63 GPIO_ACTIVE_LOW>;
		pinctrl-0 = <&sfp_pins>;
		pinctrl-names = "default";
//		rate-select0-gpios = <&qcom_pinmux 50 GPIO_ACTIVE_HIGH>;
//		rate-select0-gpios = <&qcom_pinmux 50 GPIO_ACTIVE_LOW>;
//		tx-disable-gpios = <&qcom_pinmux 49 GPIO_ACTIVE_HIGH>;
		tx-disable-gpios = <&qcom_pinmux 49 GPIO_ACTIVE_LOW>;
		tx-fault-gpios = <&qcom_pinmux 67 GPIO_ACTIVE_HIGH>;
	};
};

&adm_dma {
	status = "okay";
};

&gmac0 {
	mdiobus = <&mdio0>;
	mtd-mac-address = <&hard_config 0x10>;
	mtd-mac-address-increment = <0>;
	phy-mode = "rgmii";
	pinctrl-0 = <&rgmii2_pins>;
	pinctrl-names = "default";
	qcom,id = <0>;
	status = "okay";

	fixed-link {
		speed = <1000>;
		full-duplex;
	};
};

&gmac1 {
	mtd-mac-address = <&hard_config 0x10>;
	mtd-mac-address-increment = <1>;
	phy-mode = "sgmii";
	qcom,id = <1>;
//	sfp = <&sfp_gmac1>;
	status = "okay";

	fixed-link {
		speed = <1000>;
		full-duplex;
	};
};

&gmac2 {
	mdiobus = <&mdio0>;
	mtd-mac-address = <&hard_config 0x10>;
	mtd-mac-address-increment = <2>;
	phy-mode = "sgmii";
	qcom,id = <2>;
	status = "okay";

	fixed-link {
		speed = <1000>;
		full-duplex;
	};
};

&gmac3 {
	mdiobus = <&mdio1>;
	mtd-mac-address = <&hard_config 0x10>;
	mtd-mac-address-increment = <3>;
	phy-mode = "sgmii";
	qcom,id = <3>;
	status = "okay";

	fixed-link {
		speed = <1000>;
		full-duplex;
	};
};

&gsbi2 {
	qcom,mode = <GSBI_PROT_SPI>;
	status = "okay";

	spi@124a0000 {
		compatible = "qcom,spi-qup-v1.1.1";
		reg = <0x124a0000 0x1000>;
		interrupts = <GIC_SPI 196 IRQ_TYPE_LEVEL_HIGH>;

		clocks = <&gcc GSBI2_QUP_CLK>, <&gcc GSBI2_H_CLK>;
		clock-names = "core", "iface";

		#address-cells = <1>;
		#size-cells = <0>;

		pinctrl-0 = <&spi2_pins>;
		pinctrl-names = "default";

		cs-gpios = <&qcom_pinmux 24 GPIO_ACTIVE_HIGH>;

		spi-max-frequency = <2000000>;
	};
};

&gsbi4 {
	qcom,mode = <GSBI_PROT_I2C_UART>;
	status = "disabled";

	serial@16340000 {
		status = "disabled";
	};

	/*
	 * The i2c device on gsbi4 should not be enabled.
	 * On ipq806x designs gsbi4 i2c is meant for exclusive
	 * RPM usage. Turning this on in kernel manifests as
	 * i2c failure for the RPM.
	 */
};

&gsbi5 {
	qcom,mode = <GSBI_PROT_SPI>;
	status = "okay";

	spi@1a280000 {
		status = "okay";

		pinctrl-0 = <&spi_pins>;
		pinctrl-names = "default";

		cs-gpios = <&qcom_pinmux 20 GPIO_ACTIVE_HIGH>;

		flash: m25p80@0 {
			compatible = "jedec,spi-nor";
			#address-cells = <1>;
			#size-cells = <1>;
			spi-max-frequency = <51200000>;
			reg = <0>;

			partitions {
				compatible = "fixed-partitions";
				#address-cells = <1>;
				#size-cells = <1>;

				SBL1@0 {
					label = "SBL1";
					reg = <0x00000000 0x20000>;
					read-only;
				};
				MIBIB@20000 {
					label = "MIBIB";
					reg = <0x00020000 0x20000>;
					read-only;
				};
				SBL2@40000 {
					label = "SBL2";
					reg = <0x00040000 0x40000>;
					read-only;
				};
				SBL3@80000 {
					label = "SBL3";
					reg = <0x00080000 0x80000>;
					read-only;
				};
				DDRCONFIG@100000 {
					label = "DDRCONFIG";
					reg = <0x00100000 0x10000>;
					read-only;
				};
				SSD@110000 {
					label = "SSD";
					reg = <0x00110000 0x10000>;
					read-only;
				};
				TZ@120000 {
					label = "TZ";
					reg = <0x00120000 0x80000>;
					read-only;
				};
				RPM@1a0000 {
					label = "RPM";
					reg = <0x001a0000 0x20000>;
					read-only;
				};
				APPSBL@1c0000 {
					label = "APPSBL";
					reg = <0x001c0000 0x40000>;
					read-only;
				};
				hard_config: RBHARDCONFIG@1cf000 {
					label = "hard_config";
					reg = <0x001cf000 0x01000>;
					read-only;
				};
				RBSOFTCONFIG@1e0000 {
					label = "soft_config";
					reg = <0x001e0000 0x01000>;
				};
			};
		};
	};
};

&gsbi7 {
	qcom,mode = <GSBI_PROT_I2C_UART>;
	status = "okay";
};

&gsbi7_serial {
	status = "okay";
};

&mdio0 {
	status = "okay";

	pinctrl-0 = <&mdio0_pins>;
	pinctrl-names = "default";

	ethernet-phy@0 {
		reg = <0>;
		qca,ar8327-initvals = <
			0x00004 0x07600000  /* PAD0_MODE */
			0x00008 0x01000000  /* PAD5_MODE */
			0x0000c 0x00000080  /* PAD6_MODE */
			0x000e4 0x000aa545  /* MAC_POWER_SEL */
			0x000e0 0xc74164de  /* SGMII_CTRL */
			0x0007c 0x4e        /* PORT0_STATUS */
			0x00094 0x4e        /* PORT6_STATUS */
			0x00970 0x1e864443  /* QM_PORT0_CTRL0 */
			0x00974 0x000001c6  /* QM_PORT0_CTRL1 */
			0x00978 0x19008643  /* QM_PORT1_CTRL0 */
			0x0097c 0x000001c6  /* QM_PORT1_CTRL1 */
			0x00980 0x19008643  /* QM_PORT2_CTRL0 */
			0x00984 0x000001c6  /* QM_PORT2_CTRL1 */
			0x00988 0x19008643  /* QM_PORT3_CTRL0 */
			0x0098c 0x000001c6  /* QM_PORT3_CTRL1 */
			0x00990 0x19008643  /* QM_PORT4_CTRL0 */
			0x00994 0x000001c6  /* QM_PORT4_CTRL1 */
			0x00998 0x1e864443  /* QM_PORT5_CTRL0 */
			0x0099c 0x000001c6  /* QM_PORT5_CTRL1 */
			0x009a0 0x1e864443  /* QM_PORT6_CTRL0 */
			0x009a4 0x000001c6  /* QM_PORT6_CTRL1 */
		>;
		qca,ar8327-vlans = <
			0x1	0x7f	    /* VLAN1 Ports 0/1/2/3/4/5/6 */
		>;
	};

	ethernet-phy@4 {
		reg = <4>;
		qca,ar8327-initvals = <
			0x000e4 0x6a545     /* MAC_POWER_SEL */
			0x0000c 0x80        /* PAD6_MODE */
		>;
	};
};

&nand_controller {
	status = "okay";

	pinctrl-0 = <&nand_pins>;
	pinctrl-names = "default";

	nand@0 {
		reg = <0>;
		compatible = "qcom,nandcs";

		nand-ecc-strength = <4>;
		nand-bus-width = <8>;
		nand-ecc-step-size = <512>;

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@0 {
				label = "kernel";
				reg = <0x00000000 0x1000000>;
			};

			partition@1000000 {
				label = "ubi";
				reg = <0x1000000 0x7000000>;
			};
		};
	};
};

&qcom_pinmux {
	pinctrl-0 = <&switch0_reset_pin &switch1_reset_pin>;
	pinctrl-names = "default";

	i2c1_pins: i2c1-pinmux {
		pins = "gpio53", "gpio54";
		function = "gsbi1";
		bias-disable;
	};

	led_general_pins: led-general-pins {
		mux {
			pins = "gpio33";
			function = "gpio";
			drive-strength = <2>;
			bias-pull-down;
		};
	};

	mdio0_pins: mdio0-pins {
		mux {
			pins = "gpio0", "gpio1";
			function = "mdio";
			drive-strength = <8>;
			bias-disable;
		};

		clk {
			pins = "gpio1";
			input-disable;
		};
	};

	mdio1_pins: mdio1-pins {
		mux {
			pins = "gpio10", "gpio11";
			function = "mdio";
			drive-strength = <8>;
			bias-disable;
		};

		clk {
			pins = "gpio11";
			input-disable;
		};
	};

	nand_pins: nand-pins {
		mux {
			pins = "gpio34", "gpio35", "gpio36",
			       "gpio37", "gpio38", "gpio39",
			       "gpio40", "gpio41", "gpio42",
			       "gpio43", "gpio44", "gpio45",
			       "gpio46", "gpio47";
			function = "nand";
			drive-strength = <10>;
			bias-disable;
		};
		pullups {
			pins = "gpio39";
			bias-pull-up;
		};
		hold {
			pins = "gpio40", "gpio41", "gpio42",
			       "gpio43", "gpio44", "gpio45",
			       "gpio46", "gpio47";
			bias-bus-hold;
		};
	};

	reset_button_pins: reset-button-pins {
		mux {
			pins = "gpio66";
			function = "gpio";
			drive-strength = <2>;
			bias-pull-up;
		};
	};

	rgmii2_pins: rgmii2-pins {
		mux {
			pins = "gpio27", "gpio28", "gpio29", "gpio30", "gpio31",
			       "gpio32", "gpio51", "gpio52", "gpio59", "gpio60",
			       "gpio61", "gpio62";
			function = "rgmii2";
			drive-strength = <8>;
			bias-disable;
		};

		tx {
			pins = "gpio27", "gpio28", "gpio29", "gpio30", "gpio31", "gpio32" ;
			input-disable;
		};
	};

	sfp_pins: sfp-pins {
		mux {
			pins = "gpio49", "gpio50", "gpio63", "gpio67", "gpio68";
			function = "gpio";
			drive-strength = <16>;
			bias-disable;
		};
	};

	spi2_pins: spi2-pins {
		mux {
			pins = "gpio22", "gpio23", "gpio25";
			function = "gsbi2";
			drive-strength = <10>;
			bias-none;
		};
	};

	spi6_pins: spi6-pins {
		mux {
			pins = "gpio55", "gpio58";
			function = "gsbi6";
			drive-strength = <10>;
			bias-none;
		};
	};

	switch0_reset_pin: switch0-reset-pin {
		mux {
			pins = "gpio16";
			function = "gpio";
			drive-strength = <16>;
			bias-pull-down;
			output-high;
		};
	};

	switch1_reset_pin: switch1-reset-pin {
		mux {
			pins = "gpio17";
			function = "gpio";
			drive-strength = <16>;
			bias-pull-down;
			output-high;
		};
	};

	usb0_pwr_en_pins: usb0-pwr-en-pins {
		mux {
			pins = "gpio4";
			function = "gpio";
			drive-strength = <16>;
			bias-disable;
			output-high;
		};
	};
};

&soc {
	gsbi1: gsbi@12440000 {
		compatible = "qcom,gsbi-v1.0.0";
		cell-index = <1>;
		reg = <0x12440000 0x100>;
		clocks = <&gcc GSBI1_H_CLK>;
		clock-names = "iface";
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;
		status = "disabled";

		syscon-tcsr = <&tcsr>;

		uart1: serial@12450000 {
			compatible = "qcom,msm-uartdm-v1.3", "qcom,msm-uartdm";
			reg = <0x12450000 0x1000>,
				  <0x12440000 0x1000>;
			interrupts = <GIC_SPI 195 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&gcc GSBI1_UART_CLK>, <&gcc GSBI1_H_CLK>;
			clock-names = "core", "iface";
			status = "disabled";
		};

		i2c@12460000 {
			compatible = "qcom,i2c-qup-v1.1.1";
			reg = <0x12460000 0x1000>;
			interrupts = <GIC_SPI 196 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&gcc GSBI1_QUP_CLK>, <&gcc GSBI1_H_CLK>;
			clock-names = "core", "iface";
			status = "disabled";

			#address-cells = <1>;
			#size-cells = <0>;
		};
	};

	gsbi3: gsbi@16200000 {
		compatible = "qcom,gsbi-v1.0.0";
		cell-index = <3>;
		reg = <0x16200000 0x100>;
		clocks = <&gcc GSBI3_H_CLK>;
		clock-names = "iface";
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;
		status = "disabled";

		syscon-tcsr = <&tcsr>;

		uart3: serial@16240000 {
			compatible = "qcom,msm-uartdm-v1.3", "qcom,msm-uartdm";
			reg = <0x16240000 0x1000>,
				  <0x16200000 0x1000>;
			interrupts = <GIC_SPI 150 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&gcc GSBI3_UART_CLK>, <&gcc GSBI3_H_CLK>;
			clock-names = "core", "iface";
			status = "disabled";
		};

		i2c@16280000 {
			compatible = "qcom,i2c-qup-v1.1.1";
			reg = <0x16280000 0x1000>;
			interrupts = <GIC_SPI 151 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&gcc GSBI3_QUP_CLK>, <&gcc GSBI3_H_CLK>;
			clock-names = "core", "iface";
			status = "disabled";

			#address-cells = <1>;
			#size-cells = <0>;
		};
	};

	gsbi6: gsbi@16500000 {
		qcom,mode = <GSBI_PROT_SPI>;
		compatible = "qcom,gsbi-v1.0.0";
		cell-index = <6>;
		reg = <0x16500000 0x100>;
		clocks = <&gcc GSBI6_H_CLK>;
		clock-names = "iface";
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;

		syscon-tcsr = <&tcsr>;

		uart6: serial@16540000 {
			compatible = "qcom,msm-uartdm-v1.3", "qcom,msm-uartdm";
			reg = <0x16540000 0x1000>,
				  <0x16500000 0x1000>;
			interrupts = <GIC_SPI 156 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&gcc GSBI6_UART_CLK>, <&gcc GSBI6_H_CLK>;
			clock-names = "core", "iface";
			status = "disabled";
		};

		i2c@16580000 {
			compatible = "qcom,i2c-qup-v1.1.1";
			reg = <0x16580000 0x1000>;
			interrupts = <GIC_SPI 157 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&gcc GSBI6_QUP_CLK>, <&gcc GSBI6_H_CLK>;
			clock-names = "core", "iface";
			status = "disabled";

			#address-cells = <1>;
			#size-cells = <0>;
		};

		spi@16580000 {
			compatible = "qcom,spi-qup-v1.1.1";
			reg = <0x16580000 0x1000>;
			interrupts = <GIC_SPI 157 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&gcc GSBI6_QUP_CLK>, <&gcc GSBI6_H_CLK>;
			clock-names = "core", "iface";

			#address-cells = <1>;
			#size-cells = <0>;

			pinctrl-0 = <&spi6_pins>;
			pinctrl-names = "default";

			cs-gpios = <&qcom_pinmux 57 GPIO_ACTIVE_HIGH>;

			spi-max-frequency = <15000000>;
		};
	};

	mdio1: mdio@37200000 {
		#address-cells = <1>;
		#size-cells = <0>;

		compatible = "qcom,ipq8064-mdio", "syscon";
		reg = <0x37200000 0x200000>;
		resets = <&gcc GMAC_CORE2_RESET>;
		reset-names = "stmmaceth";
		clocks = <&gcc GMAC_CORE2_CLK>;
		clock-names = "stmmaceth";

		pinctrl-0 = <&mdio1_pins>;
		pinctrl-names = "default";

		ethernet-phy@0 {
			reg = <0>;
			qca,ar8327-initvals = <
				0x00004 0x0000080   /* PAD0_MODE */
				0x00008 0x1000000   /* PAD5_MODE */
				0x0000c 0x80        /* PAD6_MODE */
				0x00010 0x2613A0    /* SERDES DISABLE */
				0x000e4 0xaa545     /* MAC_POWER_SEL */
				0x000e0 0xc74164de  /* SGMII_CTRL */
				0x0007c 0x4e        /* PORT0_STATUS */
				0x00094 0x4e        /* PORT6_STATUS */
				0x00970 0x1e864443  /* QM_PORT0_CTRL0 */
				0x00974 0x000001c6  /* QM_PORT0_CTRL1 */
				0x00978 0x19008643  /* QM_PORT1_CTRL0 */
				0x0097c 0x000001c6  /* QM_PORT1_CTRL1 */
				0x00980 0x19008643  /* QM_PORT2_CTRL0 */
				0x00984 0x000001c6  /* QM_PORT2_CTRL1 */
				0x00988 0x19008643  /* QM_PORT3_CTRL0 */
				0x0098c 0x000001c6  /* QM_PORT3_CTRL1 */
				0x00990 0x19008643  /* QM_PORT4_CTRL0 */
				0x00994 0x000001c6  /* QM_PORT4_CTRL1 */
				0x00998 0x1e864443  /* QM_PORT5_CTRL0 */
				0x0099c 0x000001c6  /* QM_PORT5_CTRL1 */
				0x009a0 0x1e864443  /* QM_PORT6_CTRL0 */
				0x009a4 0x000001c6  /* QM_PORT6_CTRL1 */
			>;
			qca,ar8327-vlans = <
				0x1	0x7e	    /* VLAN1 Ports 1/2/3/4/5/6 */
			>;
		};

		ethernet-phy@4 {
			reg = <4>;
			qca,ar8327-initvals = <
				0x000e4 0x6a545     /* MAC_POWER_SEL */
				0x0000c 0x80        /* PAD6_MODE */
			>;
		};
	};
};

&usb3_0 { /* USB3 port 0 HS phy */
//			clocks = <&gcc USB30_1_UTMI_CLK>;
	pinctrl-0 = <&usb0_pwr_en_pins>;
	pinctrl-names = "default";
//	status = "okay";
};
